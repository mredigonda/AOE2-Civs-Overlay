<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Age of Empires II Civilization Selector</title>
        <link rel="stylesheet" href="./civ-selector.css" />
    </head>
    <body>
        <div
            id="drag-icon"
            style="
                position: fixed;
                top: 5px;
                right: 5px;
                width: 16px;
                height: 16px;
                background: rgba(255, 215, 0, 0.8);
                border: 1px solid rgba(255, 255, 255, 0.3);
                border-radius: 2px;
                cursor: move;
                z-index: 9999;
                -webkit-app-region: drag;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 10px;
                color: rgba(0, 0, 0, 0.8);
                font-weight: bold;
                user-select: none;
                pointer-events: auto;
            "
            title="Drag to move window"
        >
            ‚ãÆ‚ãÆ
        </div>
        <div id="app">
            <p>Loading civ-selector...</p>
        </div>

        <!-- Simple Screen Capture Component -->
        <div
            id="screen-capture"
            style="
                margin-top: 10px;
                padding: 10px;
                background: rgba(0, 0, 0, 0.8);
                border: 1px solid rgba(255, 255, 255, 0.2);
                pointer-events: auto !important;
                user-select: auto;
            "
        >
            <div
                style="
                    display: flex;
                    align-items: center;
                    justify-content: space-between;
                    margin-bottom: 10px;
                "
            >
                <h3
                    style="
                        margin: 0;
                        color: #ffd700;
                        font-size: 16px;
                        font-weight: bold;
                    "
                >
                    Screen Capture
                </h3>
                <button
                    id="capture-btn"
                    style="
                        background: rgba(255, 215, 0, 0.8);
                        border: 1px solid rgba(255, 255, 255, 0.3);
                        color: rgba(0, 0, 0, 0.8);
                        padding: 6px 12px;
                        font-size: 12px;
                        cursor: pointer;
                        border-radius: 2px;
                        font-weight: bold;
                    "
                >
                    üì∏ Capture
                </button>
            </div>

            <div
                id="capture-status"
                style="
                    font-size: 12px;
                    color: rgba(255, 255, 255, 0.7);
                    margin-bottom: 10px;
                "
            >
                Ready to capture screen
            </div>
            
            <div
                id="display-info"
                style="
                    font-size: 11px;
                    color: rgba(255, 255, 255, 0.5);
                    margin-bottom: 10px;
                    display: none;
                "
            >
                <div id="current-display-text"></div>
                <button
                    id="refresh-display-btn"
                    style="
                        background: rgba(255, 255, 255, 0.1);
                        border: 1px solid rgba(255, 255, 255, 0.2);
                        color: rgba(255, 255, 255, 0.7);
                        padding: 2px 6px;
                        font-size: 10px;
                        cursor: pointer;
                        border-radius: 2px;
                        margin-top: 5px;
                    "
                >
                    üîÑ Refresh Display Info
                </button>
            </div>

            <div
                id="capture-preview"
                style="
                    display: none;
                    max-width: 100%;
                    border: 1px solid rgba(255, 255, 255, 0.2);
                    margin-top: 10px;
                "
            >
                <div style="
                    padding: 8px;
                    background: rgba(0, 0, 0, 0.5);
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
                ">
                    <span style="font-size: 11px; color: rgba(255, 255, 255, 0.7)">
                        Screenshot captured and saved automatically
                    </span>
                    <span style="font-size: 10px; color: rgba(255, 255, 255, 0.5)">
                        Raw Image
                    </span>
                </div>
                <img
                    id="capture-image"
                    style="width: 100%; height: auto; display: block"
                />
            </div>



            <!-- OCR Text Display -->
            <div
                id="ocr-text-display"
                style="
                    display: none;
                    margin-top: 10px;
                    padding: 10px;
                    background: rgba(0, 0, 0, 0.8);
                    border: 1px solid rgba(255, 255, 255, 0.2);
                    max-height: 200px;
                    overflow-y: auto;
                "
            >
                <div style="
                    display: flex;
                    align-items: center;
                    justify-content: space-between;
                    margin-bottom: 10px;
                ">
                    <h4 style="
                        margin: 0;
                        color: #ffd700;
                        font-size: 14px;
                        font-weight: bold;
                    ">Extracted Text</h4>
                    <div style="
                        display: flex;
                        align-items: center;
                        gap: 10px;
                    ">
                        <div id="ocr-status" style="
                            font-size: 11px;
                            color: rgba(255, 255, 255, 0.6);
                        ">Processing...</div>
                        <button id="copy-text-btn" style="
                            background: rgba(0, 123, 255, 0.8);
                            border: 1px solid rgba(255, 255, 255, 0.3);
                            color: white;
                            padding: 4px 8px;
                            font-size: 10px;
                            cursor: pointer;
                            border-radius: 2px;
                            font-weight: bold;
                            display: none;
                        ">üìã Copy</button>
                    </div>
                </div>
                <div id="ocr-text-content" style="
                    font-size: 12px;
                    color: white;
                    line-height: 1.4;
                    white-space: pre-wrap;
                    font-family: monospace;
                "></div>
            </div>
            </div>
        </div>
        <div
            id="civ-info"
            style="
                display: none;
                color: white;
                font-family: Arial, sans-serif;
                font-size: 14px;
                line-height: 1.4;
                pointer-events: auto;
                user-select: auto;
                position: relative;
                z-index: 1000;
                margin: 0;
                padding: 0;
            "
        ></div>

        <script src="./civ-selector.js"></script>
        <script>
            // IPC communication
            const { ipcRenderer } = require("electron");

            // Function to update window size from frontend
            async function updateWindowSize(width, height) {
                try {
                    const result = await ipcRenderer.invoke(
                        "update-window-size",
                        width,
                        height
                    );
                    if (result.success) {
                        console.log(
                            `Window size updated to ${width}x${height}`
                        );
                        return result;
                    } else {
                        console.error(
                            "Failed to update window size:",
                            result.error
                        );
                        return result;
                    }
                } catch (error) {
                    console.error("Error updating window size:", error);
                    return { success: false, error: error.message };
                }
            }

            // Make the function globally available
            window.updateWindowSize = updateWindowSize;

            // Screen Capture Functionality
            let capturedImageData = null;

            // Initialize screen capture component
            document.addEventListener("DOMContentLoaded", () => {
                const captureBtn = document.getElementById("capture-btn");
                const captureStatus = document.getElementById("capture-status");
                const capturePreview =
                    document.getElementById("capture-preview");
                const captureImage = document.getElementById("capture-image");
                const ocrDisplay = document.getElementById("ocr-text-display");
                const ocrStatus = document.getElementById("ocr-status");
                const ocrContent = document.getElementById("ocr-text-content");
                const copyTextBtn = document.getElementById("copy-text-btn");
                const displayInfo = document.getElementById("display-info");
                const currentDisplayText = document.getElementById("current-display-text");
                const refreshDisplayBtn = document.getElementById("refresh-display-btn");

                // Capture button click handler
                captureBtn.addEventListener("click", async () => {
                    try {
                        captureStatus.textContent = "Capturing screen...";
                        captureBtn.disabled = true;
                        captureBtn.textContent = "‚è≥ Capturing...";

                        // Use IPC to capture screen from main process
                        const result = await ipcRenderer.invoke(
                            "capture-screen"
                        );

                        if (result.success) {
                            capturedImageData = result.imageData;

                            // Debug: Check if imageData is valid
                            console.log(
                                "Image data length:",
                                capturedImageData
                                    ? capturedImageData.length
                                    : "null"
                            );
                            console.log(
                                "Image data starts with:",
                                capturedImageData
                                    ? capturedImageData.substring(0, 50)
                                    : "null"
                            );

                            if (
                                !capturedImageData ||
                                capturedImageData.length < 100
                            ) {
                                throw new Error("Invalid image data received");
                            }

                            // Display the captured image
                            captureImage.src = capturedImageData;
                            capturePreview.style.display = "block";

                            // Auto-save the screenshot
                            await autoSaveScreenshot(capturedImageData);

                            // Extract text from screenshot using OCR
                            await extractTextFromScreenshot(capturedImageData);

                            captureBtn.textContent = "üì∏ Capture";
                            captureBtn.disabled = false;

                            // Auto-resize window to accommodate the preview
                            setTimeout(async () => {
                                try {
                                    const currentWidth = window.innerWidth;
                                    const captureComponent =
                                        document.getElementById(
                                            "screen-capture"
                                        );
                                    const totalHeight =
                                        captureComponent.offsetHeight + 100;

                                    await window.updateWindowSize(
                                        currentWidth,
                                        totalHeight
                                    );
                                } catch (error) {
                                    console.error(
                                        "Failed to resize window for capture preview:",
                                        error
                                    );
                                }
                            }, 100);
                        } else {
                            throw new Error(result.error);
                        }
                    } catch (error) {
                        console.error("Screen capture failed:", error);
                        captureStatus.textContent = `Capture failed: ${error.message}`;
                        captureBtn.textContent = "üì∏ Capture";
                        captureBtn.disabled = false;
                    }
                });

                // Auto-save screenshot function
                async function autoSaveScreenshot(imageData) {
                    try {
                        // Debug: Check image data before saving
                        console.log(
                            "Auto-saving image data length:",
                            imageData.length
                        );

                        // Ensure the data URL is properly formatted
                        if (!imageData.startsWith("data:image/")) {
                            throw new Error("Invalid image data format");
                        }

                        // Save directly to file system using main process
                        const saveResult = await ipcRenderer.invoke(
                            "save-screenshot",
                            imageData
                        );

                        if (saveResult.success) {
                            captureStatus.textContent = `Screenshot captured and saved as ${saveResult.filename}!`;
                            console.log(
                                `Screenshot saved to: ${saveResult.filePath}`
                            );
                        } else {
                            throw new Error(saveResult.error);
                        }
                    } catch (error) {
                        console.error("Failed to auto-save image:", error);
                        captureStatus.textContent = `Capture successful but save failed: ${error.message}`;
                    }
                }

                // OCR text extraction function
                async function extractTextFromScreenshot(imageData) {
                    try {
                        ocrDisplay.style.display = "block";
                        ocrStatus.textContent = "Processing OCR...";
                        ocrContent.textContent = "";
                        copyTextBtn.style.display = "none";

                        const ocrResult = await ipcRenderer.invoke("extract-text-from-screenshot", imageData);

                        if (ocrResult.success) {
                            const confidence = ocrResult.confidence ? Math.round(ocrResult.confidence) : null;
                            ocrStatus.textContent = confidence ? `OCR completed (${confidence}% confidence)` : "OCR completed";
                            ocrContent.textContent = ocrResult.text || "No text found";
                            copyTextBtn.style.display = "block";
                        } else {
                            ocrStatus.textContent = "OCR failed";
                            ocrContent.textContent = `Error: ${ocrResult.error}`;
                        }
                    } catch (error) {
                        console.error("OCR processing failed:", error);
                        ocrStatus.textContent = "OCR failed";
                        ocrContent.textContent = `Error: ${error.message}`;
                    }
                }

                // Copy text button click handler
                copyTextBtn.addEventListener("click", async () => {
                    try {
                        const textToCopy = ocrContent.textContent;
                        if (textToCopy && textToCopy !== "No text found") {
                            await navigator.clipboard.writeText(textToCopy);
                            copyTextBtn.textContent = "‚úÖ Copied!";
                            setTimeout(() => {
                                copyTextBtn.textContent = "üìã Copy";
                            }, 2000);
                        }
                    } catch (error) {
                        console.error("Failed to copy text:", error);
                        copyTextBtn.textContent = "‚ùå Failed";
                        setTimeout(() => {
                            copyTextBtn.textContent = "üìã Copy";
                        }, 2000);
                    }
                });

                // Display info functionality
                async function updateDisplayInfo() {
                    try {
                        const result = await ipcRenderer.invoke("get-current-display-info");
                        if (result.success) {
                            const display = result.display;
                            currentDisplayText.innerHTML = `
                                <strong>Current Display:</strong> ID ${display.id}<br>
                                <strong>Resolution:</strong> ${display.size.width}√ó${display.size.height}<br>
                                <strong>Scale Factor:</strong> ${display.scaleFactor}x<br>
                                <strong>Position:</strong> (${display.bounds.x}, ${display.bounds.y})
                            `;
                            displayInfo.style.display = "block";
                        } else {
                            currentDisplayText.textContent = `Error: ${result.error}`;
                            displayInfo.style.display = "block";
                        }
                    } catch (error) {
                        console.error("Failed to get display info:", error);
                        currentDisplayText.textContent = `Error: ${error.message}`;
                        displayInfo.style.display = "block";
                    }
                }

                // Refresh display info button click handler
                refreshDisplayBtn.addEventListener("click", updateDisplayInfo);

                // Show display info on page load
                updateDisplayInfo();
            });
        </script>
        <script>
            // Usage example
            const civs = [
                { code: "ARM", name: "Armenians" },
                { code: "AZT", name: "Aztecs" },
                { code: "BENG", name: "Bengalis" },
                { code: "BER", name: "Berbers" },
                { code: "BOH", name: "Bohemians" },
                { code: "BRI", name: "Britons" },
                { code: "BUL", name: "Bulgarians" },
                { code: "BURGU", name: "Burgundians" },
                { code: "BUR", name: "Burmese" },
                { code: "BYZ", name: "Byzantines" },
                { code: "CEL", name: "Celts" },
                { code: "CHI", name: "Chinese" },
                { code: "CUM", name: "Cumans" },
                { code: "DRAV", name: "Dravidians" },
                { code: "ETH", name: "Ethiopians" },
                { code: "FRK", name: "Franks" },
                { code: "GEO", name: "Georgians" },
                { code: "GOT", name: "Goths" },
                { code: "GURJ", name: "Gurjaras" },
                { code: "HIN", name: "Hindustanis" },
                { code: "HUN", name: "Huns" },
                { code: "INC", name: "Inca" },
                { code: "ITA", name: "Italians" },
                { code: "JAP", name: "Japanese" },
                { code: "JUR", name: "Jurchens" },
                { code: "KHI", name: "Khitans" },
                { code: "KHM", name: "Khmer" },
                { code: "KOR", name: "Koreans" },
                { code: "LIT", name: "Lithuanians" },
                { code: "MAG", name: "Magyars" },
                { code: "MALY", name: "Malay" },
                { code: "MAL", name: "Malians" },
                { code: "MAY", name: "Maya" },
                { code: "MON", name: "Mongols" },
                { code: "PER", name: "Persians" },
                { code: "POL", name: "Poles" },
                { code: "POR", name: "Portuguese" },
                { code: "ROM", name: "Romans" },
                { code: "SAR", name: "Saracens" },
                { code: "SHU", name: "Shu" },
                { code: "SIC", name: "Sicilians" },
                { code: "SLV", name: "Slavs" },
                { code: "SPN", name: "Spanish" },
                { code: "TAT", name: "Tatars" },
                { code: "TEU", name: "Teutons" },
                { code: "TUR", name: "Turks" },
                { code: "VIE", name: "Vietnamese" },
                { code: "VIK", name: "Vikings" },
                { code: "WEI", name: "Wei" },
                { code: "WU", name: "Wu" },
            ];

            // Load civilization data
            let civData = [];

            fetch("./civ-info.json")
                .then((response) => response.json())
                .then((data) => {
                    civData = data;
                    console.log(
                        "Loaded civ data:",
                        data.length,
                        "civilizations"
                    );
                })
                .catch((error) => {
                    console.error("Error loading civ data:", error);
                });

            // Initialize the civilization selector
            console.log("Initializing civ-selector...");
            console.log("Mount element:", document.getElementById("app"));
            console.log("CivSelect available:", window.CivSelect);

            window.civSelectInstance = window.CivSelect.init({
                mount: document.getElementById("app"),
                civs: civs,
                value: null,
                onChange: function (civ) {
                    console.log("Selected civilization:", civ);
                    displayCivInfo(civ, civData);
                },
            });

            console.log("Civ-selector initialized:", window.civSelectInstance);

            // Function to display civilization information
            function displayCivInfo(selectedCiv, allCivData) {
                const civInfoDiv = document.getElementById("civ-info");
                const appDiv = document.getElementById("app");

                if (!selectedCiv || !allCivData) {
                    civInfoDiv.style.display = "none";
                    appDiv.style.display = "block";
                    return;
                }

                const civ = allCivData.find((c) => c.code === selectedCiv.code);
                if (!civ) {
                    civInfoDiv.style.display = "none";
                    appDiv.style.display = "block";
                    return;
                }

                // Hide the civ selector and show civ info
                appDiv.style.display = "none";
                civInfoDiv.style.display = "block";

                let html = `
                    <div style="background: rgba(0, 0, 0, 0.8); padding: 10px; border: 1px solid rgba(255, 255, 255, 0.2); margin: 0;">
                        <div style="display: flex; align-items: center; margin-bottom: 15px;">
                            <button id="back-button" style="
                                background: none;
                                border: none;
                                color: #ffd700;
                                font-size: 20px;
                                cursor: pointer;
                                margin-right: 10px;
                                padding: 5px;
                                transition: color 0.2s;
                            " title="Back to civ selector">‚Üê</button>
                            <h2 style="margin: 0; color: #ffd700; font-size: 24px;">${
                                civ.name
                            }</h2>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <strong style="color: #ffd700;">Focus:</strong> ${
                                civ.focus
                            }
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <strong style="color: #ffd700;">Team Bonus:</strong> ${
                                civ.teamBonus
                            }
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <strong style="color: #ffd700;">Civilization Bonuses:</strong>
                            <ul style="margin: 10px 0; padding-left: 20px;">
                                ${civ.civilizationBonuses
                                    .map((bonus) => `<li>${bonus}</li>`)
                                    .join("")}
                            </ul>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <strong style="color: #ffd700;">Unique Units:</strong>
                            <ul style="margin: 10px 0; padding-left: 20px;">
                                ${civ.uniqueUnits
                                    .map(
                                        (unit) =>
                                            `<li><strong>${unit.name}:</strong> ${unit.description}</li>`
                                    )
                                    .join("")}
                            </ul>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <strong style="color: #ffd700;">Unique Technologies:</strong>
                            <ul style="margin: 10px 0; padding-left: 20px;">
                                ${civ.uniqueTechnologies
                                    .map(
                                        (tech) =>
                                            `<li><strong>${tech.name}:</strong> ${tech.description}</li>`
                                    )
                                    .join("")}
                            </ul>
                        </div>
                `;

                if (civ.uniqueBuildings) {
                    html += `
                        <div style="margin-bottom: 15px;">
                            <strong style="color: #ffd700;">Unique Buildings:</strong>
                            <ul style="margin: 10px 0; padding-left: 20px;">
                                ${civ.uniqueBuildings
                                    .map(
                                        (building) =>
                                            `<li><strong>${building.name}:</strong> ${building.description}</li>`
                                    )
                                    .join("")}
                            </ul>
                        </div>
                    `;
                }

                html += "</div>";

                civInfoDiv.innerHTML = html;

                // Resize window to match civ-info content height after 3 seconds
                setTimeout(async () => {
                    try {
                        // Get current window width
                        const currentWidth = window.innerWidth;

                        // Measure the height of the civ-info content
                        const civInfoElement =
                            document.getElementById("civ-info");
                        const civInfoHeight = civInfoElement.offsetHeight;

                        // Resize window to match the content height
                        const result = await window.updateWindowSize(
                            currentWidth,
                            civInfoHeight - 1 // offset because sometimes there's a 1px line at the bottom... wtf
                        );

                        if (result.success) {
                            console.log(
                                `Window resized to match civ-info content height: ${civInfoHeight}px`
                            );
                        }
                    } catch (error) {
                        console.error(
                            "Failed to resize window to match content height:",
                            error
                        );
                    }
                }, 50);

                // Add event listener for back button
                const backButton = document.getElementById("back-button");
                if (backButton) {
                    backButton.addEventListener("click", () => {
                        // Show civ selector and hide civ info
                        appDiv.style.display = "block";
                        civInfoDiv.style.display = "none";

                        // Clear the current selection
                        if (window.civSelectInstance) {
                            window.civSelectInstance.value = null;
                            window.civSelectInstance.input.value = "";
                        }
                    });

                    // Add hover effect
                    backButton.addEventListener("mouseenter", () => {
                        backButton.style.color = "#ffffff";
                    });

                    backButton.addEventListener("mouseleave", () => {
                        backButton.style.color = "#ffd700";
                    });
                }
            }
        </script>
    </body>
</html>
